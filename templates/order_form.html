{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="container py-5 mt-header">
    <div class="row justify-content-center">
        <div class="col-md-10">
            <div class="card p-4 shadow">
                <h2 class="text-center fw-bold SelfStorage_green mb-4">Оформление заказа</h2>
                
                {% if messages %}
                    {% for message in messages %}
                        <div class="alert alert-{{ message.tags }}">{{ message }}</div>
                    {% endfor %}
                {% endif %}
                
                <div class="mb-4 text-center">
                    <div class="btn-group" role="group">
                        <input type="radio" class="btn-check" name="mode_switch" id="mode_manual_btn" checked>
                        <label class="btn btn-outline-success btn-lg" for="mode_manual_btn">
                            Выбрать конкретный бокс
                        </label>
                        
                        <input type="radio" class="btn-check" name="mode_switch" id="mode_auto_btn">
                        <label class="btn btn-outline-primary btn-lg" for="mode_auto_btn">
                            Подобрать по размерам
                        </label>
                    </div>
                </div>
                
                <form method="post" id="orderForm">
                    {% csrf_token %}
                    {{ form.mode }}
                    
                    <div class="mb-4">
                        <label class="fs-5 fw-bold">Склад</label>
                        {{ form.warehouse }}
                    </div>
                    
                    <div id="manual_block" class="mode-block">
                        <div class="alert alert-info">
                            <h5>Доступные боксы на выбранном складе</h5>
                            <p class="mb-0">Выберите конкретный бокс из списка. Размеры подставятся автоматически.</p>
                        </div>
                        
                        <div class="mb-3">
                            {{ form.selected_box }}
                            <div id="box_info" class="mt-3 p-3 bg-light rounded" style="display: none;">
                            </div>
                        </div>
                        
                        <div class="row mb-3" id="box_dimensions_info">
                            <div class="col-12">
                                <div class="card bg-light">
                                    <div class="card-body">
                                        <h6 class="card-subtitle mb-2 text-muted">Параметры выбранного бокса:</h6>
                                        <p class="card-text" id="selected_box_details">
                                            Выберите бокс чтобы увидеть размеры
                                        </p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div id="auto_block" class="mode-block" style="display: none;">
                        <div class="alert alert-primary">
                            <h5>Укажите размеры ваших вещей</h5>
                            <p class="mb-0">Система автоматически подберёт минимально подходящий бокс.</p>
                        </div>
                        
                        <div class="row mb-3">
                            <div class="col-md-4">
                                <label>{{ form.need_length.label }}</label>
                                {{ form.need_length }}
                            </div>
                            <div class="col-md-4">
                                <label>{{ form.need_width.label }}</label>
                                {{ form.need_width }}
                            </div>
                            <div class="col-md-4">
                                <label>{{ form.need_height.label }}</label>
                                {{ form.need_height }}
                            </div>
                        </div>
                        
                        <div id="auto_result" class="alert alert-success" style="display: none;">
                            <h6>Подобран бокс:</h6>
                            <p id="auto_box_info" class="mb-0"></p>
                        </div>
                        
                        <div id="auto_error" class="alert alert-danger" style="display: none;">
                            <h6> Нет подходящего бокса</h6>
                            <p id="auto_error_msg" class="mb-0"></p>
                            <hr>
                            <p class="mb-0">Переключитесь в режим "Выбрать конкретный бокс" чтобы посмотреть доступные варианты, или выберите другой склад.</p>
                        </div>
                    </div>
                    
                    <hr class="my-4">
                    
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="fs-5 fw-bold">Срок аренды</label>
                            {{ form.rental_duration }}
                        </div>
                        <div class="col-md-6">
                            <label class="fs-5 fw-bold">Дата начала</label>
                            {{ form.start_date }}
                        </div>
                    </div>
                    
                    <div class="card bg-light mb-4" id="price_preview" style="display: none;">
                        <div class="card-body">
                            <h5 class="card-title">Предварительный расчёт</h5>
                            <table class="table table-sm">
                                <tr>
                                    <td>Бокс:</td>
                                    <td id="preview_box" class="fw-bold">-</td>
                                </tr>
                                <tr>
                                    <td>Размеры:</td>
                                    <td id="preview_dims">-</td>
                                </tr>
                                <tr>
                                    <td>Объём:</td>
                                    <td id="preview_volume">-</td>
                                </tr>
                                <tr class="table-success">
                                    <td>В месяц:</td>
                                    <td id="preview_monthly" class="fw-bold">-</td>
                                </tr>
                                <tr class="table-success">
                                    <td>Итого:</td>
                                    <td id="preview_total" class="fw-bold fs-5">-</td>
                                </tr>
                                <tr id="discount_row" style="display: none;">
                                    <td class="text-success">Скидка:</td>
                                    <td id="preview_discount" class="text-success">-</td>
                                </tr>
                            </table>
                        </div>
                    </div>
                    
                    <div class="mb-4">
                        <div class="form-check">
                            {{ form.pdn_accepted }}
                            <label class="form-check-label" for="{{ form.pdn_accepted.id_for_label }}">
                                {{ form.pdn_accepted.label }}
                                <a href="{% static 'files/pdn.pdf' %}" 
                                target="_blank" 
                                class="text-decoration-none SelfStorage_green ms-1">
                                    (ознакомиться с документом)
                                </a>
                            </label>
                        </div>
                        {% if form.pdn_accepted.errors %}
                            <div class="text-danger small mt-1">{{ form.pdn_accepted.errors }}</div>
                        {% endif %}
                    </div>
                    
                    <div class="d-grid">
                        <button type="submit" class="btn btn-lg py-3 text-white SelfStorage__bg_orange" id="submit_btn" disabled>
                            Оформить заказ
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const modeInput = document.getElementById('id_mode');
    const manualBtn = document.getElementById('mode_manual_btn');
    const autoBtn = document.getElementById('mode_auto_btn');
    const manualBlock = document.getElementById('manual_block');
    const autoBlock = document.getElementById('auto_block');
    
    const warehouseSelect = document.getElementById('id_warehouse');
    const selectedBox = document.getElementById('id_selected_box');
    const needLength = document.getElementById('id_need_length');
    const needWidth = document.getElementById('id_need_width');
    const needHeight = document.getElementById('id_need_height');
    const duration = document.getElementById('id_duration');
    
    const boxDetails = document.getElementById('selected_box_details');
    const autoResult = document.getElementById('auto_result');
    const autoError = document.getElementById('auto_error');
    const pricePreview = document.getElementById('price_preview');
    const submitBtn = document.getElementById('submit_btn');
    
    let warehouseBoxes = {};
    
    function setMode(mode) {
        modeInput.value = mode;
        
        if (mode === 'manual') {
            manualBlock.style.display = 'block';
            autoBlock.style.display = 'none';
            needLength.value = '';
            needWidth.value = '';
            needHeight.value = '';
        } else {
            manualBlock.style.display = 'none';
            autoBlock.style.display = 'block';
            selectedBox.value = '';
            updateBoxInfo();
        }
        checkSubmit();
    }
    
    manualBtn.addEventListener('change', () => setMode('manual'));
    autoBtn.addEventListener('change', () => setMode('auto'));
    
    function loadWarehouseBoxes() {
        const warehouseId = warehouseSelect.value;
        if (!warehouseId) {
            selectedBox.innerHTML = '<option value="">-- Сначала выберите склад --</option>';
            warehouseBoxes = {};
            return;
        }
        
        selectedBox.innerHTML = '<option value="">Загрузка...</option>';
        
        fetch(`/storage/ajax/get-boxes/?warehouse_id=${warehouseId}`)
            .then(r => r.json())
            .then(data => {
                warehouseBoxes = {};
                selectedBox.innerHTML = '<option value="">-- Выберите бокс --</option>';
                
                data.boxes.forEach(box => {
                    if (!box.disabled) {
                        warehouseBoxes[box.id] = box;
                        const option = document.createElement('option');
                        option.value = box.id;
                        const match = box.label.match(/№([\w-]+).*?(\d+\.?\d*)м³/);
                        const num = match ? match[1] : box.id;
                        const vol = match ? match[2] : '?';
                        option.textContent = `№${num} — ${vol}м³`;
                        selectedBox.appendChild(option);
                    }
                });
                
                if (data.boxes.length === 0) {
                    selectedBox.innerHTML = '<option value="">Нет свободных боксов</option>';
                }
            });
    }
    
    warehouseSelect.addEventListener('change', () => {
        loadWarehouseBoxes();
        autoResult.style.display = 'none';
        autoError.style.display = 'none';
        pricePreview.style.display = 'none';
    });
    
    function updateBoxInfo() {
        const boxId = selectedBox.value;
        if (!boxId || !warehouseBoxes[boxId]) {
            boxDetails.innerHTML = '<span class="text-muted">Выберите бокс чтобы увидеть размеры</span>';
            pricePreview.style.display = 'none';
            checkSubmit();
            return;
        }
        
        fetch(`/storage/ajax/box-details/${boxId}/`)
            .then(r => r.json())
            .then(box => {
                boxDetails.innerHTML = `
                    <strong>№${box.number}</strong><br>
                    Размеры: ${box.length}×${box.width}×${box.height} м<br>
                    Объём: ${box.volume} м³<br>
                    Цена: ${box.price} ₽/мес
                `;
                
                updatePricePreview({
                    box_number: box.number,
                    box_dimensions: `${box.length}×${box.width}×${box.height}`,
                    box_volume: box.volume,
                    monthly_price: box.price,
                    original_price: box.price
                });
            });
    }
    
    selectedBox.addEventListener('change', updateBoxInfo);
    
    function tryAutoSelect() {
        const l = parseFloat(needLength.value) || 0;
        const w = parseFloat(needWidth.value) || 0;
        const h = parseFloat(needHeight.value) || 0;
        const warehouseId = warehouseSelect.value;
        
        if (!l || !w || !h || !warehouseId) {
            autoResult.style.display = 'none';
            autoError.style.display = 'none';
            return;
        }
        
        const volume = l * w * h;
        
        let suitable = null;
        for (const [id, box] of Object.entries(warehouseBoxes)) {
            const volMatch = box.label.match(/(\d+\.?\d*)м³/);
            if (volMatch) {
                const boxVol = parseFloat(volMatch[1]);
                if (boxVol >= volume && (!suitable || boxVol < suitable.volume)) {
                    suitable = { id, volume: boxVol, box };
                }
            }
        }
        
        if (suitable) {
            fetch(`/storage/ajax/box-details/${suitable.id}/`)
                .then(r => r.json())
                .then(box => {
                    autoResult.style.display = 'block';
                    autoError.style.display = 'none';
                    document.getElementById('auto_box_info').innerHTML = `
                        <strong>№${box.number}</strong> — ${box.volume}м³ 
                        (${box.length}×${box.width}×${box.height}м)<br>
                        <small>Ваш объём: ${volume.toFixed(2)}м³</small>
                    `;
                    
                    updatePricePreview({
                        box_number: box.number,
                        box_dimensions: `${box.length}×${box.width}×${box.height}`,
                        box_volume: box.volume,
                        monthly_price: box.price,
                        original_price: box.price
                    });
                });
        } else {
            autoResult.style.display = 'none';
            autoError.style.display = 'block';
            document.getElementById('auto_error_msg').textContent = 
                `Нужен бокс от ${volume.toFixed(2)}м³. На этом складе нет подходящего.`;
            pricePreview.style.display = 'none';
        }
        
        checkSubmit();
    }
    
    [needLength, needWidth, needHeight].forEach(input => {
        input.addEventListener('input', tryAutoSelect);
    });
    
    function updatePricePreview(data) {
        const months = parseInt(duration.value) || 1;
        let discount = 0;
        if (months >= 12) discount = 0.15;
        else if (months >= 6) discount = 0.10;
        
        const finalMonthly = data.original_price * (1 - discount);
        const total = finalMonthly * months;
        
        document.getElementById('preview_box').textContent = `№${data.box_number}`;
        document.getElementById('preview_dims').textContent = data.box_dimensions;
        document.getElementById('preview_volume').textContent = `${data.box_volume} м³`;
        document.getElementById('preview_monthly').textContent = `${finalMonthly.toFixed(2)} ₽`;
        document.getElementById('preview_total').textContent = `${total.toFixed(2)} ₽`;
        
        const discountRow = document.getElementById('discount_row');
        if (discount > 0) {
            discountRow.style.display = 'table-row';
            document.getElementById('preview_discount').textContent = `${(discount*100).toFixed(0)}%`;
        } else {
            discountRow.style.display = 'none';
        }
        
        pricePreview.style.display = 'block';
        checkSubmit();
    }
    
    duration.addEventListener('change', () => {
        if (selectedBox.value) updateBoxInfo();
        else if (needLength.value) tryAutoSelect();
    });
    
    function checkSubmit() {
        const mode = modeInput.value;
        const hasWarehouse = warehouseSelect.value;
        const hasPdn = document.getElementById('id_pdn').checked;
        
        let ready = false;
        
        if (mode === 'manual') {
            ready = hasWarehouse && selectedBox.value && hasPdn;
        } else {
            const hasDims = needLength.value && needWidth.value && needHeight.value;
            const hasResult = autoResult.style.display === 'block';
            ready = hasWarehouse && hasDims && hasResult && hasPdn;
        }
        
        submitBtn.disabled = !ready;
    }
    
    document.getElementById('id_pdn').addEventListener('change', checkSubmit);
    
    loadWarehouseBoxes();
});
</script>
{% endblock %}