{% extends 'base.html' %}
{% load static %}

{% block title %}Оформление заказа — SelfStorage{% endblock %}

{% block content %}
<div class="container py-5 mt-header">
    <div class="row justify-content-center">
        <div class="col-md-10">
            <div class="card p-4 shadow">
                <h2 class="text-center fw-bold SelfStorage_green mb-4">Оформление заказа на аренду бокса</h2>
                
                {% if messages %}
                    {% for message in messages %}
                        <div class="alert alert-{{ message.tags }} mb-3">
                            {{ message }}
                        </div>
                    {% endfor %}
                {% endif %}
                
                <form method="post">
                    {% csrf_token %}
                    
                    <!-- Шаг 1: Выбор склада -->
                    <div class="mb-4">
                        <h4 class="SelfStorage_green mb-3">1. Выберите склад</h4>
                        {{ form.warehouse }}
                        {% if form.warehouse.errors %}
                            <div class="text-danger small mt-1">{{ form.warehouse.errors }}</div>
                        {% endif %}
                        
                        <div class="alert alert-info mt-3 p-3">
                            <strong>Подсказка:</strong> Все склады имеют температурный режим 17-21°С и высоту потолков до 3.5м. 
                            Бесплатная доставка от вашего дома включена в стоимость!
                        </div>
                    </div>
                    
                    <!-- Шаг 2: Габариты вещей и расчет объема -->
                    <div class="mb-4">
                        <h4 class="SelfStorage_green mb-3">2. Укажите габариты ваших вещей</h4>
                        
                        <div class="row">
                            <div class="col-md-4 mb-3">
                                {{ form.item_length.label_tag }}
                                {{ form.item_length }}
                                {% if form.item_length.errors %}
                                    <div class="text-danger small mt-1">{{ form.item_length.errors }}</div>
                                {% endif %}
                            </div>
                            <div class="col-md-4 mb-3">
                                {{ form.item_width.label_tag }}
                                {{ form.item_width }}
                                {% if form.item_width.errors %}
                                    <div class="text-danger small mt-1">{{ form.item_width.errors }}</div>
                                {% endif %}
                            </div>
                            <div class="col-md-4 mb-3">
                                {{ form.item_height.label_tag }}
                                {{ form.item_height }}
                                {% if form.item_height.errors %}
                                    <div class="text-danger small mt-1">{{ form.item_height.errors }}</div>
                                {% endif %}
                            </div>
                        </div>
                        
                        <div class="alert alert-warning mt-3 p-3">
                            <strong>Важно!</strong> Габариты вещей будут замерены на месте сотрудником склада. 
                            Стоимость аренды может измениться в зависимости от фактического объема хранения.
                        </div>
                        
                        <div class="card bg-light p-3 mt-3">
                            <h5 class="mb-2">Рассчитанный объем: <span id="calculated-volume">3.00</span> м³</h5>
                            <p class="mb-0 text-muted">Объем рассчитывается как: длина × ширина × высота</p>
                        </div>
                    </div>
                    
                    <!-- Шаг 3: Срок аренды -->
                    <div class="mb-4">
                        <h4 class="SelfStorage_green mb-3">3. Срок аренды</h4>
                        
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                {{ form.rental_duration.label_tag }}
                                {{ form.rental_duration }}
                                {% if form.rental_duration.errors %}
                                    <div class="text-danger small mt-1">{{ form.rental_duration.errors }}</div>
                                {% endif %}
                            </div>
                        </div>
                        
                        <div class="card bg-light p-3 mt-3">
                            <h5 class="mb-2">Стоимость аренды:</h5>
                            <p class="mb-1">Ежемесячно: <span id="monthly-price">705.00</span> ₽</p>
                            <p class="mb-1">Итого за <span id="duration-text">1</span> месяц(ев): <span id="total-price">705.00</span> ₽</p>
                            <p class="mb-0 text-success">Скидка: <span id="discount-text">0%</span></p>
                            <p class="mb-0 text-muted small mt-2">
                                Скидка 10% при аренде от 6 месяцев, 15% при аренде от 12 месяцев
                            </p>
                        </div>
                    </div>
                    
                    <!-- Шаг 4: Дата начала -->
                    <div class="mb-4">
                        <h4 class="SelfStorage_green mb-3">4. Дата начала аренды</h4>
                        {{ form.start_date.label_tag }}
                        {{ form.start_date }}
                        {% if form.start_date.errors %}
                            <div class="text-danger small mt-1">{{ form.start_date.errors }}</div>
                        {% endif %}
                        
                        <div class="alert alert-info mt-3 p-3">
                            <strong>Обратите внимание:</strong> Минимальный срок аренды — 1 месяц. 
                            Договор автоматически продлевается, если вы не сообщите о расторжении за 10 дней до окончания срока.
                        </div>
                    </div>
                    
                    <!-- Шаг 5: Согласие на ПДн -->
                    <div class="mb-4">
                        <h4 class="SelfStorage_green mb-3">5. Согласие на обработку данных</h4>
                        <div class="form-check mb-3">
                            {{ form.pdn_accepted }}
                            <label for="{{ form.pdn_accepted.id_for_label }}" class="form-check-label">
                                {{ form.pdn_accepted.label }}
                                <a href="{% static 'files/pdn.pdf' %}" target="_blank" class="text-decoration-none SelfStorage_green ms-1">
                                    (ознакомиться с документом)
                                </a>
                            </label>
                        </div>
                        {% if form.pdn_accepted.errors %}
                            <div class="text-danger small mt-1">{{ form.pdn_accepted.errors }}</div>
                        {% endif %}
                    </div>
                    
                    <div class="d-grid mt-4">
                        <button type="submit" class="btn py-3 px-5 text-white fs_24 SelfStorage__bg_orange SelfStorage__btn2_orange">
                            Оформить заказ
                        </button>
                    </div>
                    
                    <div class="text-center mt-3">
                        <span class="text-muted">
                            После оформления заказа с вами свяжется менеджер для подтверждения деталей и замера габаритов
                        </span>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

{% if calculator_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Элементы формы
    const lengthInput = document.getElementById('id_item_length');
    const widthInput = document.getElementById('id_item_width');
    const heightInput = document.getElementById('id_item_height');
    const durationInput = document.getElementById('id_rental_duration');
    
    // Элементы для отображения расчетов
    const volumeElement = document.getElementById('calculated-volume');
    const monthlyPriceElement = document.getElementById('monthly-price');
    const totalPriceElement = document.getElementById('total-price');
    const durationTextElement = document.getElementById('duration-text');
    const discountTextElement = document.getElementById('discount-text');
    
    // Тарифы за м³ (средние из макета boxes.html)
    const tariff_small = 470;   // До 3м³: 1408 ₽ / 3м³ ≈ 470 ₽/м³
    const tariff_medium = 215;  // До 10м³: 2154 ₽ / 10м³ ≈ 215 ₽/м³
    const tariff_large = 226;   // Свыше 10м³: 2264 ₽ / 10м³ ≈ 226 ₽/м³
    
    // Функция пересчета стоимости
    function recalculate() {
        // Получаем значения
        const length = parseFloat(lengthInput.value) || 0;
        const width = parseFloat(widthInput.value) || 0;
        const height = parseFloat(heightInput.value) || 0;
        const duration = parseInt(durationInput.value) || 1;
        
        // Расчет объема
        const volume = length * width * height;
        volumeElement.textContent = volume.toFixed(2);
        
        // Определение тарифа по объему
        let basePricePerM3;
        if (volume <= 3) {
            basePricePerM3 = tariff_small;
        } else if (volume <= 10) {
            basePricePerM3 = tariff_medium;
        } else {
            basePricePerM3 = tariff_large;
        }
        
        // Расчет ежемесячной стоимости
        let monthlyPrice = volume * basePricePerM3;
        
        // Расчет скидки за долгосрочную аренду
        let discount = 0;
        if (duration >= 12) {
            discount = 0.15;
        } else if (duration >= 6) {
            discount = 0.10;
        }
        
        // Применение скидки
        monthlyPrice = monthlyPrice * (1 - discount);
        
        // Итоговая стоимость
        const totalPrice = monthlyPrice * duration;
        
        // Обновление элементов интерфейса
        monthlyPriceElement.textContent = monthlyPrice.toFixed(2);
        totalPriceElement.textContent = totalPrice.toFixed(2);
        durationTextElement.textContent = duration;
        discountTextElement.textContent = `${Math.round(discount * 100)}%`;
    }
    
    // Назначаем обработчики событий
    [lengthInput, widthInput, heightInput, durationInput].forEach(input => {
        input.addEventListener('input', recalculate);
    });
    
    // Первичный расчет при загрузке страницы
    recalculate();
});
</script>
{% endif %}
{% endblock %}